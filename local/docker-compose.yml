services:
  firestore:
    build:
      context: ..
      dockerfile: local/firestore-emulator/Dockerfile
    container_name: pklnd-firestore-emulator
    stop_grace_period: 60s
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "${FIRESTORE_EMULATOR_PORT:-8085}:8080"
      - "4000:4000"
    volumes:
      - ../.local/firestore:/data
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 3s
      retries: 20
    environment:
      - CLOUDSDK_CORE_PROJECT=${FIRESTORE_PROJECT_ID:-pklnd-local}

  receipt-parser:
    build:
      context: ..
      dockerfile: receipt-parser/Dockerfile
    container_name: pklnd-receipt-parser
    depends_on:
      firestore:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: local
      PORT: 8081
      PROJECT_ID: ${FIRESTORE_PROJECT_ID:-pklnd-local}
      FIRESTORE_PROJECT_ID: ${FIRESTORE_PROJECT_ID:-pklnd-local}
      FIRESTORE_DATABASE_ID: ${FIRESTORE_DATABASE_ID:-receipts-db}
      FIRESTORE_EMULATOR_HOST: firestore:8080
      LOCAL_PROJECT_ID: ${FIRESTORE_PROJECT_ID:-pklnd-local}
    ports:
      - "${PARSER_PORT:-8081}:8081"

  web:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: pklnd-web
    depends_on:
      firestore:
        condition: service_healthy
      receipt-parser:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: local
      FIRESTORE_ENABLED: "true"
      FIRESTORE_EMULATOR_HOST: firestore:8080
      FIRESTORE_PROJECT_ID: ${FIRESTORE_PROJECT_ID:-pklnd-local}
      FIRESTORE_DATABASE_ID: ${FIRESTORE_DATABASE_ID:-receipts-db}
      FIRESTORE_DEFAULT_ROLE: ROLE_USER
      RECEIPT_PROCESSOR_BASE_URL: http://receipt-parser:8081
      RECEIPT_PROCESSOR_USE_ID_TOKEN: "false"
      RECEIPT_PROCESSOR_ENABLED: "true"
      GCS_ENABLED: "false"
    ports:
      - "${WEB_PORT:-8080}:8080"
