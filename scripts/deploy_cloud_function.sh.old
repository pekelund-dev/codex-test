#!/bin/bash

# Cloud Function Deployment Script for Receipt Processing
# This script automates the deployment of the receiptProcessingF    --trigger-bucket="$GCS_BUCKET" 
    --set-env-vars="VERTEX_AI_PROJECT_ID=$EXPECTED_PROJECT,VERTEX_AI_LOCATION=$REGION,VERTEX_AI_GEMINI_MODEL=gemini-1.5-pro,RECEIPT_FIRESTORE_COLLECTION=receiptExtractions"

if [ $? -ne 0 ]; then
    echo "‚ùå Cloud Function deployment failed. Please check the error messages above."
    exit 1
fi

# Allow unauthenticated invocations for Eventarc triggers
echo "üîì Configuring Cloud Run service for unauthenticated invocations..."
gcloud run services add-iam-policy-binding "$CLOUD_FUNCTION_NAME" 
    --region="$REGION" 
    --member="allUsers" 
    --role="roles/run.invoker" 
    --quiet

echo "üéâ Cloud Function deployed successfully!"ction
# incorporating all the troubleshooting steps and best practices

set -e  # Exit on any error

echo "üöÄ Starting Cloud Function deployment..."

# Source environment variables
source setup-env.sh

# Check if we're in the correct project
CURRENT_PROJECT=$(gcloud config get-value project)
EXPECTED_PROJECT="codex-test-473008"

if [ "$CURRENT_PROJECT" != "$EXPECTED_PROJECT" ]; then
    echo "‚ö†Ô∏è  Switching to project: $EXPECTED_PROJECT"
    gcloud config set project $EXPECTED_PROJECT
fi

# Check bucket region
echo "üìç Checking bucket region..."
BUCKET_REGION=$(gcloud storage buckets describe gs://$GCS_BUCKET --format="value(location)" 2>/dev/null || echo "")

if [ -z "$BUCKET_REGION" ]; then
    echo "‚ùå Could not determine bucket region for gs://$GCS_BUCKET"
    echo "Please ensure the bucket exists and you have access to it."
    exit 1
fi

echo "‚úÖ Bucket $GCS_BUCKET is in region: $BUCKET_REGION"

# Use bucket region for function deployment
REGION=$(echo $BUCKET_REGION | tr '[:upper:]' '[:lower:]')
echo "üìç Using region $REGION for function deployment"

# Enable required APIs
echo "üîß Enabling required Google Cloud APIs..."
gcloud services enable \
    cloudfunctions.googleapis.com \
    cloudbuild.googleapis.com \
    artifactregistry.googleapis.com \
    run.googleapis.com \
    aiplatform.googleapis.com \
    eventarc.googleapis.com \
    firestore.googleapis.com \
    storage.googleapis.com \
    pubsub.googleapis.com

echo "‚úÖ APIs enabled successfully"

# Create service account if it doesn't exist
echo "üë§ Setting up service account..."
SA_EXISTS=$(gcloud iam service-accounts list --filter="email:$FUNCTION_SA" --format="value(email)" | wc -l)

if [ "$SA_EXISTS" -eq 0 ]; then
    echo "Creating service account: $FUNCTION_SA"
    gcloud iam service-accounts create receipt-parser \
        --display-name="Receipt parsing Cloud Function"
else
    echo "‚úÖ Service account already exists: $FUNCTION_SA"
fi

# Grant required permissions
echo "üîê Granting IAM permissions..."

# Storage permissions
gcloud storage buckets add-iam-policy-binding "gs://$GCS_BUCKET" \
    --member="serviceAccount:$FUNCTION_SA" \
    --role="roles/storage.objectAdmin" \
    --quiet

# Firestore permissions
gcloud projects add-iam-policy-binding $EXPECTED_PROJECT \
    --member="serviceAccount:$FUNCTION_SA" \
    --role="roles/datastore.user" \
    --quiet

# Vertex AI permissions
gcloud projects add-iam-policy-binding $EXPECTED_PROJECT \
    --member="serviceAccount:$FUNCTION_SA" \
    --role="roles/aiplatform.user" \
    --quiet

# Eventarc permissions
gcloud projects add-iam-policy-binding $EXPECTED_PROJECT \
    --member="serviceAccount:$FUNCTION_SA" \
    --role="roles/eventarc.eventReceiver" \
    --quiet

# Configure Eventarc Service Agent
PROJECT_NUMBER=$(gcloud projects describe $EXPECTED_PROJECT --format="value(projectNumber)")
EVENTARC_SA="service-${PROJECT_NUMBER}@gcp-sa-eventarc.iam.gserviceaccount.com"

gcloud projects add-iam-policy-binding $EXPECTED_PROJECT \
    --member="serviceAccount:$EVENTARC_SA" \
    --role="roles/eventarc.serviceAgent" \
    --quiet

gcloud projects add-iam-policy-binding $EXPECTED_PROJECT \
    --member="serviceAccount:$EVENTARC_SA" \
    --role="roles/run.invoker" \
    --quiet

# Grant GCS service account Pub/Sub Publisher role for Eventarc triggers
GCS_SA="service-${PROJECT_NUMBER}@gs-project-accounts.iam.gserviceaccount.com"
gcloud projects add-iam-policy-binding $EXPECTED_PROJECT \
    --member="serviceAccount:$GCS_SA" \
    --role="roles/pubsub.publisher" \
    --quiet

echo "‚úÖ IAM permissions configured"

# Build the project
echo "üî® Building project..."
./mvnw clean package -DskipTests -Pcloud-function

if [ $? -ne 0 ]; then
    echo "‚ùå Build failed. Please check the error messages above."
    exit 1
fi

echo "‚úÖ Project built successfully"

# Deploy the Cloud Function
echo "‚òÅÔ∏è  Deploying Cloud Function to region: $REGION"
echo "üì¶ Function: $CLOUD_FUNCTION_NAME"
echo "ü™£ Trigger bucket: $GCS_BUCKET"

gcloud functions deploy "$CLOUD_FUNCTION_NAME" \
    --gen2 \
    --region="$REGION" \
    --runtime=java21 \
    --entry-point=dev.pekelund.pklnd.function.ReceiptProcessingFunction \
    --source=. \
    --service-account="$FUNCTION_SA" \
    --trigger-bucket="$GCS_BUCKET" \
    --set-env-vars="VERTEX_AI_PROJECT_ID=$VERTEX_AI_PROJECT_ID,VERTEX_AI_LOCATION=$REGION,VERTEX_AI_GEMINI_MODEL=$VERTEX_AI_GEMINI_MODEL,RECEIPT_FIRESTORE_COLLECTION=$RECEIPT_FIRESTORE_COLLECTION" \
    --timeout=540s \
    --memory=512Mi

if [ $? -eq 0 ]; then
    echo ""
    echo "üéâ Cloud Function deployed successfully!"
    echo ""
    echo "üìã Function Details:"
    echo "   Name: $CLOUD_FUNCTION_NAME"
    echo "   Region: $REGION"
    echo "   Trigger: Cloud Storage bucket '$GCS_BUCKET'"
    echo "   Runtime: Java 21"
    echo ""
    echo "üîç To view function logs:"
    echo "   gcloud functions logs read $CLOUD_FUNCTION_NAME --region=$REGION --gen2"
    echo ""
    echo "üß™ To test the function, upload a PDF to the bucket:"
    echo "   gsutil cp your-receipt.pdf gs://$GCS_BUCKET/receipts/"
    echo ""
else
    echo "‚ùå Cloud Function deployment failed."
    echo "Check the error messages above and refer to the troubleshooting guide in docs/gcp-setup-gcloud.md"
    exit 1
fi
