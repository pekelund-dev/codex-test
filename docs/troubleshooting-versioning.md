# Troubleshooting Versioning Issues

This guide helps diagnose and fix issues with version display and git metadata in deployed applications.

## Problem: Version Showing Incorrectly

### Step 1: Check Cloud Build Logs

When you run `./scripts/terraform/deploy_services.sh`, you'll see output like:
```
Created [https://cloudbuild.googleapis.com/v1/projects/PROJECT/locations/global/builds/BUILD_ID].
Logs are available at [ https://console.cloud.google.com/cloud-build/builds/BUILD_ID?project=PROJECT ].
```

**You must click on these URLs** to see the actual build logs. The `gcloud builds submit` command output does NOT show the Docker build logs.

### Step 2: Look for Debug Output in Cloud Build Logs

In the Cloud Build logs (from the URL above), look for:

```
Generating git.properties for Cloud Build...
GIT_BRANCH=your-branch-name
GIT_COMMIT=your-commit-hash
Extracted PROJECT_VERSION=0.1.0-SNAPSHOT
Created git.properties:
#Generated by Dockerfile build
git.branch=your-branch-name
git.commit.id=your-commit-hash
git.commit.id.abbrev=abc1234
git.build.time=2025-12-10T12:00:00+0000
git.build.version=0.1.0-SNAPSHOT
```

And later:
```
Verifying git.properties in JAR:
#Generated by Dockerfile build
git.branch=...
git.build.version=0.1.0-SNAPSHOT
...
```

### Step 3: Diagnose Based on Output

**If GIT_BRANCH and GIT_COMMIT are empty:**
- The deploy script isn't passing git metadata correctly
- Check that you're running the script from within the git repository
- Verify `git rev-parse HEAD` and `git rev-parse --abbrev-ref HEAD` work in your shell

**If PROJECT_VERSION is wrong:**
- The grep command isn't extracting the version from pom.xml correctly
- Check that `grep -oP '<version>\K[^<]+' pom.xml | head -1` returns `0.1.0-SNAPSHOT`

**If git.properties looks correct but isn't in the JAR:**
- Maven resources plugin may not be copying the file
- Check for errors during the Maven build phase

**If git.properties is in the JAR but UI shows wrong version:**
- The Java code might not be reading the property correctly
- Check application logs for errors loading GitProperties
- Verify the deployed service is using the new image (not cached)

### Step 4: Check Deployed Application

Visit your deployed application's version display (in the red bar below navbar). It should show:
```
Version: 0.1.0-SNAPSHOT · Gren: branch-name · commit: abc1234
```

If it shows a different version:
1. Check which Docker image tag is deployed in Cloud Run
2. Verify that image was built with the latest code
3. Clear any CDN/browser caches
4. Check if Cloud Run is using a cached image

## Problem: Artifact Cleanup Not Working

### Step 1: Check Complete Deployment Output

The cleanup happens AFTER Terraform completes. Look for output at the END of the deployment:

```
Apply complete! Resources: 0 added, 2 changed, 0 destroyed.

Outputs:
...

Cleaning up Cloud Build source cache...
Cleaning up old container images in Artifact Registry...
Only 2 timestamped image(s) found for IMAGE_BASE, keeping all (threshold: 3)
Artifact cleanup complete
```

### Step 2: Verify Timestamp Format

List your images manually:
```bash
gcloud artifacts docker tags list \
  us-east1-docker.pkg.dev/PROJECT_ID/web/pklnd-web \
  --format="get(tag)" --sort-by="CREATE_TIME"
```

You should see tags like:
```
20251210-114440
20251210-120450
latest
```

The cleanup script only deletes tags matching the pattern `YYYYMMDD-HHMMSS`. If your tags don't match this pattern, they won't be cleaned up.

### Step 3: Manual Cleanup

If you have more than 3 timestamped images but they're not being deleted:

1. Check the tags match the pattern: `grep -E '^[0-9]{8}-[0-9]{6}$'`
2. Manually test the cleanup function:
   ```bash
   PROJECT_ID=your-project ./scripts/terraform/cleanup_artifacts.sh
   ```
3. Check for permission errors - the gcloud command might be failing silently

### Step 4: Debug the Cleanup Script

Add debug output to the script temporarily:
```bash
# In deploy_services.sh, after line 217:
echo "DEBUG: all_tags=${all_tags}"
echo "DEBUG: timestamped_tags=${timestamped_tags}"
echo "DEBUG: total_count=${total_count}"
```

This will show exactly what tags are being found and counted.

## Common Issues

### Issue: Version shows 3.5.7 (Spring Boot parent version)

**Cause:** The git-commit-id-plugin is generating its own git.properties, overwriting the Docker-generated one, or git.properties isn't being generated at all.

**Fix:** Verify the `-Dgit-commit-id-plugin.skip=true` flag is being passed during Docker builds.

### Issue: Version shows "okänd version" (unknown version)

**Cause:** The git.properties file doesn't contain `git.build.version`, or the Java code can't read it.

**Fix:** Check that the Docker build logs show the git.properties file being created with all properties.

### Issue: Cleanup runs but doesn't delete anything

**Cause:** You likely have fewer than 4 timestamped images. The cleanup only deletes when you have MORE than 3 images.

**Solution:** This is expected behavior. Deploy 4 times, then the oldest will be deleted on the 4th deployment.

### Issue: Git metadata is empty/unknown

**Cause:** The deploy script can't find git information, or substitutions aren't being passed to Cloud Build.

**Fix:**
1. Ensure you're running from within the git repository
2. Check that `.git` directory exists and is accessible
3. Verify the `gcloud builds submit` command includes `--substitutions` with `_GIT_BRANCH` and `_GIT_COMMIT`

## Getting Help

When reporting version or cleanup issues, please include:

1. Complete deployment script output (don't truncate at "Waiting for build...")
2. Cloud Build logs from the URLs provided in the output
3. Output of `gcloud artifacts docker tags list` for your image
4. What version is actually showing in the deployed UI
5. Output of manually running: `git rev-parse HEAD` and `git rev-parse --abbrev-ref HEAD`
